!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):(e=e||self,function(){var n=e["ECSY-Two"],r=e["ECSY-Two"]={};t(r),r.noConflict=function(){return e["ECSY-Two"]=n,r}}())}(this,(function(exports){"use strict";class EventDispatcher{constructor(){this._listeners={},this.stats={fired:0,handled:0}}addEventListener(e,t){let n=this._listeners;void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t)}hasEventListener(e,t){return void 0!==this._listeners[e]&&-1!==this._listeners[e].indexOf(t)}removeEventListener(e,t){var n=this._listeners[e];if(void 0!==n){var r=n.indexOf(t);-1!==r&&n.splice(r,1)}}dispatchEvent(e,t,n){this.stats.fired++;var r=this._listeners[e];if(void 0!==r)for(var o=r.slice(0),s=0;s<o.length;s++)o[s].call(this,t,n)}resetCounters(){this.stats.fired=this.stats.handled=0}}function getName(e){return e.name}function queryKey(e){for(var t=[],n=0;n<e.length;n++){var r=e[n];if("object"==typeof r){var o="not"===r.operator?"!":r.operator;t.push(o+getName(r.Component))}else t.push(getName(r))}return t.sort().join("-")}class Query{constructor(e,t){if(this.Components=[],this.NotComponents=[],e.forEach(e=>{"object"==typeof e?this.NotComponents.push(e.Component):this.Components.push(e)}),0===this.Components.length)throw new Error("Can't create a query without components");this.entities=[],this.eventDispatcher=new EventDispatcher,this.reactive=!1,this.key=queryKey(e);for(var n=0;n<t._entities.length;n++){var r=t._entities[n];this.match(r)&&(r.queries.push(this),this.entities.push(r))}}addEntity(e){e.queries.push(this),this.entities.push(e),this.eventDispatcher.dispatchEvent(Query.prototype.ENTITY_ADDED,e)}removeEntity(e){let t=this.entities.indexOf(e);~t&&(this.entities.splice(t,1),t=e.queries.indexOf(this),e.queries.splice(t,1),this.eventDispatcher.dispatchEvent(Query.prototype.ENTITY_REMOVED,e))}match(e){return e.hasAllComponents(this.Components)&&!e.hasAnyComponents(this.NotComponents)}toJSON(){return{key:this.key,reactive:this.reactive,components:{included:this.Components.map(e=>e.name),not:this.NotComponents.map(e=>e.name)},numEntities:this.entities.length}}stats(){return{numComponents:this.Components.length,numEntities:this.entities.length}}}Query.prototype.ENTITY_ADDED="Query#ENTITY_ADDED",Query.prototype.ENTITY_REMOVED="Query#ENTITY_REMOVED",Query.prototype.COMPONENT_CHANGED="Query#COMPONENT_CHANGED";class System{canExecute(){if(0===this._mandatoryQueries.length)return!0;for(let e=0;e<this._mandatoryQueries.length;e++){if(0===this._mandatoryQueries[e].entities.length)return!1}return!0}constructor(e,t){if(this.world=e,this.enabled=!0,this._queries={},this.queries={},this.priority=0,this.executeTime=0,t&&t.priority&&(this.priority=t.priority),this._mandatoryQueries=[],this.initialized=!0,this.constructor.queries)for(var n in this.constructor.queries){var r=this.constructor.queries[n],o=r.components;if(!o||0===o.length)throw new Error("'components' attribute can't be empty in a query");var s=this.world.entityManager.queryComponents(o);this._queries[n]=s,!0===r.mandatory&&this._mandatoryQueries.push(s),this.queries[n]={results:s.entities};const e={added:Query.prototype.ENTITY_ADDED,removed:Query.prototype.ENTITY_REMOVED,changed:Query.prototype.COMPONENT_CHANGED};r.listen&&["added","removed","changed"].forEach(t=>{if(r.listen[t]){let o=r.listen[t];if("changed"===t){if(s.reactive=!0,!0===o){let e=this.queries[n][t]=[];s.eventDispatcher.addEventListener(Query.prototype.COMPONENT_CHANGED,t=>{-1===e.indexOf(t)&&e.push(t)})}else if(Array.isArray(o)){let e=this.queries[n][t]=[];s.eventDispatcher.addEventListener(Query.prototype.COMPONENT_CHANGED,(t,n)=>{-1!==o.indexOf(n.constructor)&&-1===e.indexOf(t)&&e.push(t)})}}else{let r=this.queries[n][t]=[];s.eventDispatcher.addEventListener(e[t],e=>{-1===r.indexOf(e)&&r.push(e)})}}})}}stop(){this.executeTime=0,this.enabled=!1}play(){this.enabled=!0}clearEvents(){for(let t in this.queries){var e=this.queries[t];if(e.added&&(e.added.length=0),e.removed&&(e.removed.length=0),e.changed)if(Array.isArray(e.changed))e.changed.length=0;else for(let t in e.changed)e.changed[t].length=0}}toJSON(){var e={name:this.constructor.name,enabled:this.enabled,executeTime:this.executeTime,priority:this.priority,queries:{}};if(this.constructor.queries){var t=this.constructor.queries;for(let n in t){let r=this.queries[n],o=t[n],s=e.queries[n]={key:this._queries[n].key};if(s.mandatory=!0===o.mandatory,s.reactive=o.listen&&(!0===o.listen.added||!0===o.listen.removed||!0===o.listen.changed||Array.isArray(o.listen.changed)),s.reactive){s.listen={},["added","removed","changed"].forEach(e=>{r[e]&&(s.listen[e]={entities:r[e].length})})}}}return e}}class Component{}function createType(e){var t=["create","reset","clear"].filter(t=>!e[t]);if(t.length>0)throw new Error("createType expect type definition to implements the following functions: "+t.join(", "));return e.isType=!0,e}Component.isComponent=!0;var Types={};function generateId(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",r=n.length,o=0;o<e;o++)t+=n.charAt(Math.floor(Math.random()*r));return t}function injectScript(e,t){var n=document.createElement("script");n.src=e,n.onload=t,(document.head||document.documentElement).appendChild(n)}function hookConsoleAndErrors(e){["error","warning","log"].forEach(t=>{if("function"==typeof console[t]){var n=console[t].bind(console);console[t]=(...r)=>(e.send({method:"console",type:t,args:JSON.stringify(r)}),n.apply(null,r))}}),window.addEventListener("error",t=>{e.send({method:"error",error:JSON.stringify({message:t.error.message,stack:t.error.stack})})})}function includeRemoteIdHTML(e){let t=document.createElement("div");return t.style.cssText="\n    align-items: center;\n    background-color: #333;\n    color: #aaa;\n    display:flex;\n    font-family: Arial;\n    font-size: 1.1em;\n    height: 40px;\n    justify-content: center;\n    left: 0;\n    opacity: 0.9;\n    position: absolute;\n    right: 0;\n    text-align: center;\n    top: 0;\n  ",t.innerHTML=`Open ECSY devtools to connect to this page using the code:&nbsp;<b style="color: #fff">${e}</b>&nbsp;<button onClick="generateNewCode()">Generate new code</button>`,document.body.appendChild(t),t}function enableRemoteDevtools(remoteId){window.generateNewCode=()=>{window.localStorage.clear(),remoteId=generateId(6),window.localStorage.setItem("ecsyRemoteId",remoteId),window.location.reload(!1)},remoteId=remoteId||window.localStorage.getItem("ecsyRemoteId"),remoteId||(remoteId=generateId(6),window.localStorage.setItem("ecsyRemoteId",remoteId));let infoDiv=includeRemoteIdHTML(remoteId);window.__ECSY_REMOTE_DEVTOOLS_INJECTED=!0,window.__ECSY_REMOTE_DEVTOOLS={};let Version="",worldsBeforeLoading=[],onWorldCreated=e=>{var t=e.detail.world;Version=e.detail.version,worldsBeforeLoading.push(t)};window.addEventListener("ecsy-world-created",onWorldCreated);let onLoaded=()=>{var peer=new Peer(remoteId);peer.on("open",()=>{peer.on("connection",connection=>{window.__ECSY_REMOTE_DEVTOOLS.connection=connection,connection.on("open",(function(){infoDiv.innerHTML="Connected",connection.on("data",(function(data){if("init"===data.type){var script=document.createElement("script");script.setAttribute("type","text/javascript"),script.onload=()=>{script.parentNode.removeChild(script),window.removeEventListener("ecsy-world-created",onWorldCreated),worldsBeforeLoading.forEach(e=>{var t=new CustomEvent("ecsy-world-created",{detail:{world:e,version:Version}});window.dispatchEvent(t)})},script.innerHTML=data.script,(document.head||document.documentElement).appendChild(script),script.onload(),hookConsoleAndErrors(connection)}else if("executeScript"===data.type){let value=eval(data.script);data.returnEval&&connection.send({method:"evalReturn",value:value})}}))}))})})};injectScript("https://cdn.jsdelivr.net/npm/peerjs@0.3.20/dist/peer.min.js",onLoaded)}Types.Number=createType({baseType:Number,isSimpleType:!0,create:e=>void 0!==e?e:0,reset:(e,t,n)=>{e[t]=void 0!==n?n:0},clear:(e,t)=>{e[t]=0}}),Types.Boolean=createType({baseType:Boolean,isSimpleType:!0,create:e=>void 0!==e&&e,reset:(e,t,n)=>{e[t]=void 0!==n&&n},clear:(e,t)=>{e[t]=!1}}),Types.String=createType({baseType:String,isSimpleType:!0,create:e=>void 0!==e?e:"",reset:(e,t,n)=>{e[t]=void 0!==n?n:""},clear:(e,t)=>{e[t]=""}}),Types.Array=createType({baseType:Array,create:e=>void 0!==e?e.slice():[],reset:(e,t,n)=>{void 0!==n?e[t]=n.slice():e[t].length=0},clear:(e,t)=>{e[t].length=0},copy:(e,t,n)=>{e[n]=t[n].slice()}});const urlParams=new URLSearchParams(window.location.search);urlParams.has("enable-remote-devtools")&&enableRemoteDevtools();class Canvas extends Component{constructor(){super(),this.scale=1,this.dom=null,this.pixelMode=!1,this.width=100,this.height=100}}class BackgroundFill extends Component{constructor(){super(),this.color="white"}}class Camera extends Component{constructor(){super(),this.x=0,this.y=0,this.centered=!0}}class CameraFollowsSprite extends Component{constructor(){super(),this.target=null}}class Sprite extends Component{constructor(){super(),this.x=0,this.y=0,this.width=10,this.height=10}left(){return this.x}right(){return this.x+this.width}top(){return this.y}bottom(){return this.y+this.height}intersects(e){return this.right()>=e.left()&&this.left()<=e.right()&&this.top()<=e.bottom()&&this.bottom()>=e.top()}union(e){let t=new Sprite,n=this;return t.x=Math.min(n.x,e.x),t.y=Math.min(n.y,e.y),t.width=Math.max(n.right(),e.right())-Math.min(n.left(),e.left()),t.height=Math.max(n.bottom(),e.bottom())-Math.min(n.top(),e.top()),t}}class DebugOutline{constructor(){this.color="red"}}class FilledSprite extends Component{constructor(){super(),this.color="red"}}class ECSYTwoSystem extends System{execute(e,t){this.queries.canvas.added.forEach(e=>{let t=e.getMutableComponent(Canvas);t.dom=document.createElement("canvas"),t.dom.width=t.width*t.scale,t.dom.height=t.height*t.scale,document.body.append(t.dom)}),this.queries.canvas.results.forEach(e=>{let t=e.getComponent(Canvas),n=t.dom.getContext("2d");n.imageSmoothingEnabled=!t.pixelMode,n.save(),n.scale(t.scale,t.scale),this.queries.background.results.forEach(e=>{let r=e.getComponent(BackgroundFill);n.fillStyle=r.color,n.fillRect(0,0,t.dom.width,t.dom.height)}),n.restore()})}}function startWorld(e){let t=performance.now();!function n(){const r=performance.now(),o=r-t;e.execute(o,r),t=r,requestAnimationFrame(n)}()}ECSYTwoSystem.queries={canvas:{components:[Canvas],listen:{added:!0}},background:{components:[BackgroundFill]}};class InputState extends Component{constructor(){super(),this.states={},this.changed=!0,this.released=!1}anyChanged(){return this.changed}anyReleased(){return this.released}}exports.BackgroundFill=BackgroundFill,exports.Camera=Camera,exports.CameraFollowsSprite=CameraFollowsSprite,exports.Canvas=Canvas,exports.DebugOutline=DebugOutline,exports.ECSYTwoSystem=ECSYTwoSystem,exports.FilledSprite=FilledSprite,exports.InputState=InputState,exports.Sprite=Sprite,exports.startWorld=startWorld,Object.defineProperty(exports,"__esModule",{value:!0})}));
