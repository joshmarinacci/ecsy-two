!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):(e=e||self,function(){var s=e["ECSY-Two"],r=e["ECSY-Two"]={};t(r),r.noConflict=function(){return e["ECSY-Two"]=s,r}}())}(this,(function(exports){"use strict";class EventDispatcher{constructor(){this._listeners={},this.stats={fired:0,handled:0}}addEventListener(e,t){let s=this._listeners;void 0===s[e]&&(s[e]=[]),-1===s[e].indexOf(t)&&s[e].push(t)}hasEventListener(e,t){return void 0!==this._listeners[e]&&-1!==this._listeners[e].indexOf(t)}removeEventListener(e,t){var s=this._listeners[e];if(void 0!==s){var r=s.indexOf(t);-1!==r&&s.splice(r,1)}}dispatchEvent(e,t,s){this.stats.fired++;var r=this._listeners[e];if(void 0!==r)for(var o=r.slice(0),i=0;i<o.length;i++)o[i].call(this,t,s)}resetCounters(){this.stats.fired=this.stats.handled=0}}function getName(e){return e.name}function queryKey(e){for(var t=[],s=0;s<e.length;s++){var r=e[s];if("object"==typeof r){var o="not"===r.operator?"!":r.operator;t.push(o+getName(r.Component))}else t.push(getName(r))}return t.sort().join("-")}class Query{constructor(e,t){if(this.Components=[],this.NotComponents=[],e.forEach(e=>{"object"==typeof e?this.NotComponents.push(e.Component):this.Components.push(e)}),0===this.Components.length)throw new Error("Can't create a query without components");this.entities=[],this.eventDispatcher=new EventDispatcher,this.reactive=!1,this.key=queryKey(e);for(var s=0;s<t._entities.length;s++){var r=t._entities[s];this.match(r)&&(r.queries.push(this),this.entities.push(r))}}addEntity(e){e.queries.push(this),this.entities.push(e),this.eventDispatcher.dispatchEvent(Query.prototype.ENTITY_ADDED,e)}removeEntity(e){let t=this.entities.indexOf(e);~t&&(this.entities.splice(t,1),t=e.queries.indexOf(this),e.queries.splice(t,1),this.eventDispatcher.dispatchEvent(Query.prototype.ENTITY_REMOVED,e))}match(e){return e.hasAllComponents(this.Components)&&!e.hasAnyComponents(this.NotComponents)}toJSON(){return{key:this.key,reactive:this.reactive,components:{included:this.Components.map(e=>e.name),not:this.NotComponents.map(e=>e.name)},numEntities:this.entities.length}}stats(){return{numComponents:this.Components.length,numEntities:this.entities.length}}}Query.prototype.ENTITY_ADDED="Query#ENTITY_ADDED",Query.prototype.ENTITY_REMOVED="Query#ENTITY_REMOVED",Query.prototype.COMPONENT_CHANGED="Query#COMPONENT_CHANGED";class System{canExecute(){if(0===this._mandatoryQueries.length)return!0;for(let e=0;e<this._mandatoryQueries.length;e++){if(0===this._mandatoryQueries[e].entities.length)return!1}return!0}constructor(e,t){if(this.world=e,this.enabled=!0,this._queries={},this.queries={},this.priority=0,this.executeTime=0,t&&t.priority&&(this.priority=t.priority),this._mandatoryQueries=[],this.initialized=!0,this.constructor.queries)for(var s in this.constructor.queries){var r=this.constructor.queries[s],o=r.components;if(!o||0===o.length)throw new Error("'components' attribute can't be empty in a query");var i=this.world.entityManager.queryComponents(o);this._queries[s]=i,!0===r.mandatory&&this._mandatoryQueries.push(i),this.queries[s]={results:i.entities};const e={added:Query.prototype.ENTITY_ADDED,removed:Query.prototype.ENTITY_REMOVED,changed:Query.prototype.COMPONENT_CHANGED};r.listen&&["added","removed","changed"].forEach(t=>{if(r.listen[t]){let o=r.listen[t];if("changed"===t){if(i.reactive=!0,!0===o){let e=this.queries[s][t]=[];i.eventDispatcher.addEventListener(Query.prototype.COMPONENT_CHANGED,t=>{-1===e.indexOf(t)&&e.push(t)})}else if(Array.isArray(o)){let e=this.queries[s][t]=[];i.eventDispatcher.addEventListener(Query.prototype.COMPONENT_CHANGED,(t,s)=>{-1!==o.indexOf(s.constructor)&&-1===e.indexOf(t)&&e.push(t)})}}else{let r=this.queries[s][t]=[];i.eventDispatcher.addEventListener(e[t],e=>{-1===r.indexOf(e)&&r.push(e)})}}})}}stop(){this.executeTime=0,this.enabled=!1}play(){this.enabled=!0}clearEvents(){for(let t in this.queries){var e=this.queries[t];if(e.added&&(e.added.length=0),e.removed&&(e.removed.length=0),e.changed)if(Array.isArray(e.changed))e.changed.length=0;else for(let t in e.changed)e.changed[t].length=0}}toJSON(){var e={name:this.constructor.name,enabled:this.enabled,executeTime:this.executeTime,priority:this.priority,queries:{}};if(this.constructor.queries){var t=this.constructor.queries;for(let s in t){let r=this.queries[s],o=t[s],i=e.queries[s]={key:this._queries[s].key};if(i.mandatory=!0===o.mandatory,i.reactive=o.listen&&(!0===o.listen.added||!0===o.listen.removed||!0===o.listen.changed||Array.isArray(o.listen.changed)),i.reactive){i.listen={},["added","removed","changed"].forEach(e=>{r[e]&&(i.listen[e]={entities:r[e].length})})}}}return e}}class Component{}function createType(e){var t=["create","reset","clear"].filter(t=>!e[t]);if(t.length>0)throw new Error("createType expect type definition to implements the following functions: "+t.join(", "));return e.isType=!0,e}Component.isComponent=!0;var Types={};function generateId(e){for(var t="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",r=s.length,o=0;o<e;o++)t+=s.charAt(Math.floor(Math.random()*r));return t}function injectScript(e,t){var s=document.createElement("script");s.src=e,s.onload=t,(document.head||document.documentElement).appendChild(s)}function hookConsoleAndErrors(e){["error","warning","log"].forEach(t=>{if("function"==typeof console[t]){var s=console[t].bind(console);console[t]=(...r)=>(e.send({method:"console",type:t,args:JSON.stringify(r)}),s.apply(null,r))}}),window.addEventListener("error",t=>{e.send({method:"error",error:JSON.stringify({message:t.error.message,stack:t.error.stack})})})}function includeRemoteIdHTML(e){let t=document.createElement("div");return t.style.cssText="\n    align-items: center;\n    background-color: #333;\n    color: #aaa;\n    display:flex;\n    font-family: Arial;\n    font-size: 1.1em;\n    height: 40px;\n    justify-content: center;\n    left: 0;\n    opacity: 0.9;\n    position: absolute;\n    right: 0;\n    text-align: center;\n    top: 0;\n  ",t.innerHTML=`Open ECSY devtools to connect to this page using the code:&nbsp;<b style="color: #fff">${e}</b>&nbsp;<button onClick="generateNewCode()">Generate new code</button>`,document.body.appendChild(t),t}function enableRemoteDevtools(remoteId){window.generateNewCode=()=>{window.localStorage.clear(),remoteId=generateId(6),window.localStorage.setItem("ecsyRemoteId",remoteId),window.location.reload(!1)},remoteId=remoteId||window.localStorage.getItem("ecsyRemoteId"),remoteId||(remoteId=generateId(6),window.localStorage.setItem("ecsyRemoteId",remoteId));let infoDiv=includeRemoteIdHTML(remoteId);window.__ECSY_REMOTE_DEVTOOLS_INJECTED=!0,window.__ECSY_REMOTE_DEVTOOLS={};let Version="",worldsBeforeLoading=[],onWorldCreated=e=>{var t=e.detail.world;Version=e.detail.version,worldsBeforeLoading.push(t)};window.addEventListener("ecsy-world-created",onWorldCreated);let onLoaded=()=>{var peer=new Peer(remoteId);peer.on("open",()=>{peer.on("connection",connection=>{window.__ECSY_REMOTE_DEVTOOLS.connection=connection,connection.on("open",(function(){infoDiv.innerHTML="Connected",connection.on("data",(function(data){if("init"===data.type){var script=document.createElement("script");script.setAttribute("type","text/javascript"),script.onload=()=>{script.parentNode.removeChild(script),window.removeEventListener("ecsy-world-created",onWorldCreated),worldsBeforeLoading.forEach(e=>{var t=new CustomEvent("ecsy-world-created",{detail:{world:e,version:Version}});window.dispatchEvent(t)})},script.innerHTML=data.script,(document.head||document.documentElement).appendChild(script),script.onload(),hookConsoleAndErrors(connection)}else if("executeScript"===data.type){let value=eval(data.script);data.returnEval&&connection.send({method:"evalReturn",value:value})}}))}))})})};injectScript("https://cdn.jsdelivr.net/npm/peerjs@0.3.20/dist/peer.min.js",onLoaded)}Types.Number=createType({baseType:Number,isSimpleType:!0,create:e=>void 0!==e?e:0,reset:(e,t,s)=>{e[t]=void 0!==s?s:0},clear:(e,t)=>{e[t]=0}}),Types.Boolean=createType({baseType:Boolean,isSimpleType:!0,create:e=>void 0!==e&&e,reset:(e,t,s)=>{e[t]=void 0!==s&&s},clear:(e,t)=>{e[t]=!1}}),Types.String=createType({baseType:String,isSimpleType:!0,create:e=>void 0!==e?e:"",reset:(e,t,s)=>{e[t]=void 0!==s?s:""},clear:(e,t)=>{e[t]=""}}),Types.Array=createType({baseType:Array,create:e=>void 0!==e?e.slice():[],reset:(e,t,s)=>{void 0!==s?e[t]=s.slice():e[t].length=0},clear:(e,t)=>{e[t].length=0},copy:(e,t,s)=>{e[s]=t[s].slice()}});const urlParams=new URLSearchParams(window.location.search);urlParams.has("enable-remote-devtools")&&enableRemoteDevtools();class Canvas extends Component{constructor(){super(),this.scale=1,this.dom=null,this.pixelMode=!1,this.width=100,this.height=100}}class BackgroundFill extends Component{constructor(){super(),this.color="white"}}class Camera extends Component{constructor(){super(),this.x=0,this.y=0,this.centered=!0}}class CameraFollowsSprite extends Component{constructor(){super(),this.target=null}}class Sprite extends Component{constructor(){super(),this.x=0,this.y=0,this.width=10,this.height=10}left(){return this.x}right(){return this.x+this.width}top(){return this.y}bottom(){return this.y+this.height}intersects(e){return this.right()>=e.left()&&this.left()<=e.right()&&this.top()<=e.bottom()&&this.bottom()>=e.top()}union(e){let t=new Sprite,s=this;return t.x=Math.min(s.x,e.x),t.y=Math.min(s.y,e.y),t.width=Math.max(s.right(),e.right())-Math.min(s.left(),e.left()),t.height=Math.max(s.bottom(),e.bottom())-Math.min(s.top(),e.top()),t}}class DebugOutline{constructor(){this.color="red"}}class FilledSprite extends Component{constructor(){super(),this.color="red"}}class ECSYTwoSystem extends System{execute(e,t){this.queries.canvas.added.forEach(e=>{let t=e.getMutableComponent(Canvas);t.dom=document.createElement("canvas"),t.dom.width=t.width*t.scale,t.dom.height=t.height*t.scale,document.body.append(t.dom)}),this.queries.canvas.results.forEach(e=>{let t=e.getComponent(Canvas),s=t.dom.getContext("2d");s.imageSmoothingEnabled=!t.pixelMode,s.save(),s.scale(t.scale,t.scale),this.queries.background.results.forEach(e=>{let r=e.getComponent(BackgroundFill);s.fillStyle=r.color,s.fillRect(0,0,t.dom.width,t.dom.height)}),s.restore()})}}function startWorld(e){let t=performance.now();!function s(){const r=performance.now(),o=r-t;e.execute(o,r),t=r,requestAnimationFrame(s)}()}ECSYTwoSystem.queries={canvas:{components:[Canvas],listen:{added:!0}},background:{components:[BackgroundFill]}};class InputState extends Component{constructor(){super(),this.states={},this.changed=!0,this.released=!1}anyChanged(){return this.changed}anyReleased(){return this.released}}class ImageSprite extends Component{constructor(){super(),this.image=null,this.src=null}}class AnimatedSprite extends Component{constructor(){super(),this.image=null,this.frame_count=1,this.current_frame=0,this.width=-1,this.height=-1,this.frame_duration=250,this.last_frame_time=0,this.src=null,this.frame_width=16}}class SpriteSystem extends System{execute(e,t){this.queries.canvas.results.forEach(e=>{let s=e.getComponent(Canvas),r=s.dom.getContext("2d");if(r.imageSmoothingEnabled=!1,r.save(),r.scale(s.scale,s.scale),e.hasComponent(Camera)){let t=e.getComponent(Camera);t.centered&&r.translate(-t.x+s.width/2,-t.y+s.height/2)}this.queries.sprites.added.forEach(e=>{let t=e.getComponent(ImageSprite);!t.image&&t.src&&(t.image=new Image,t.image.src=t.src)}),this.queries.animated_sprites.added.forEach(e=>{let t=e.getComponent(AnimatedSprite);!t.frames&&t.src&&(t.image=new Image,t.image.src=t.src)}),this.queries.filled_sprites.results.forEach(e=>{let t=e.getComponent(Sprite),s=e.getComponent(FilledSprite);r.fillStyle=s.color,r.fillRect(t.x,t.y,t.width,t.height)}),this.queries.sprites.results.forEach(t=>{let o=t.getComponent(Sprite);if(r.save(),o.fixed&&e.hasComponent(Camera)){let t=e.getComponent(Camera);r.translate(+t.x-s.width/2,+t.y-s.height/2)}r.translate(o.x,o.y);let i=t.getComponent(ImageSprite);i.flipY&&(r.scale(-1,1),r.translate(-o.width,0)),i.image&&r.drawImage(i.image,0,0),r.restore()}),this.queries.animated_sprites.results.forEach(e=>{let s=e.getMutableComponent(AnimatedSprite);t-s.last_frame_time>s.frame_duration&&(s.current_frame=(s.current_frame+1)%s.frame_count,s.last_frame_time=t);let o=e.getComponent(Sprite);r.save(),r.translate(o.x,o.y),s.flipY&&(r.scale(-1,1),r.translate(-s.width,0)),r.drawImage(s.image,s.width*s.current_frame,0,s.width,s.height,0,0,s.width,s.height),r.restore()}),this.queries.debug_sprites.results.forEach(e=>{let t=e.getComponent(Sprite),s=e.getComponent(DebugOutline);r.strokeStyle=s.color,r.strokeRect(t.x,t.y,t.width,t.height)}),r.restore()}),this.queries.camera_move.results.forEach(e=>{let t=e.getComponent(CameraFollowsSprite);if(!t.target)return;let s=t.target.getComponent(Sprite);s&&this.queries.canvas.results.forEach(e=>{if(e.hasComponent(Camera)){let t=e.getMutableComponent(Camera);t.x=s.x,t.y=s.y}})})}}SpriteSystem.queries={canvas:{components:[Canvas]},sprites:{components:[Sprite,ImageSprite],listen:{added:!0,removed:!0}},camera_move:{components:[CameraFollowsSprite]},animated_sprites:{components:[Sprite,AnimatedSprite],listen:{added:!0,removed:!0}},filled_sprites:{components:[Sprite,FilledSprite]},debug_sprites:{components:[Sprite,DebugOutline]}};class SpriteSheet{constructor(e,t,s){this.image=e,this.tw=t,this.th=s}sprite_to_image(e,t){let s=document.createElement("canvas");return s.width=this.tw,s.height=this.th,s.getContext("2d").drawImage(this.image,e*this.tw,t*this.th,this.tw,this.th,0,0,this.tw,this.th),s}sprites_to_frames(e,t,s){let r=[];for(let o=0;o<s;o++)r.push(this.sprite_to_image(e+o,t));return r}drawSpriteAt(e,t,s,r,o){e.drawImage(this.image,t*this.tw,s*this.th,this.tw,this.th,r,o,this.tw,this.th)}}function load_image_from_url(e){return new Promise((t,s)=>{let r=document.createElement("img");r.onload=()=>{console.log("Image Loaded ",e),t(r)},r.onerror=()=>s(r),r.src=e})}function make_point(e,t){return{x:e,y:t}}const FLIPPED_HORIZONTALLY_FLAG=2147483648,FLIPPED_VERTICALLY_FLAG=1073741824,FLIPPED_DIAGONALLY_FLAG=536870912;function is_flipped_horizontally(e){return 0!=(e&FLIPPED_HORIZONTALLY_FLAG)}class TileMap extends Component{constructor(){super(),this.tileSize=16,this.width=-1,this.height=-1,this.layers=[],this.index=[],this.wall_types=[]}tile_at(e,t){let s=this.layer_by_name(e),r=make_point(Math.floor(t.x/this.tileSize),Math.floor(t.y/this.tileSize));return s&&"tilelayer"===s.type?s.data[r.y*this.width+r.x]:null}set_tile_at(e,t,s){return this.layer_by_name(e).data[t.y*this.width+t.x]=s}layer_by_name(e){return this.layers.find(t=>t.name===e)}}class TileMapSystem extends System{execute(e,t){this.queries.maps.results.forEach(e=>{let t=e.getComponent(TileMap);this.queries.screen.results.forEach(e=>{let s=e.getComponent(Canvas),r=e.getComponent(Camera),o=s.dom.getContext("2d");o.imageSmoothingEnabled=!s.pixelMode,o.save(),o.scale(s.scale,s.scale),o.translate(-r.x+s.width/2,-r.y+s.height/2),t.layers.forEach(e=>{"tilelayer"===e.type&&this.drawTileLayer(t,o,e),"objectgroup"===e.type&&this.drawObjectLayer(t,o,e)}),o.restore()})})}drawTileLayer(e,t,s){for(let r=0;r<s.height;r++)for(let o=0;o<s.width;o++){let i=r*s.width+o,n=s.data[i],a=n&~(FLIPPED_HORIZONTALLY_FLAG|FLIPPED_VERTICALLY_FLAG|FLIPPED_DIAGONALLY_FLAG);if(0===a)continue;let l=e.index[a];if(l||console.error("missing tile "+a+" "+l),!l)throw new Error("missing tile "+a+" "+l);l&&(t.save(),t.translate(o*e.tilewidth,r*e.tileheight),is_flipped_horizontally(n)&&(t.scale(-1,1),t.translate(-e.tilewidth,0)),t.drawImage(l,0,0),t.restore())}}drawObjectLayer(e,t,s){s.objects.forEach(s=>{if(s.gid){let r=e.index[s.gid];if(!r)throw new Error("missing tile "+s.gid+" "+r);r&&t.drawImage(r,s.x,s.y-s.height)}})}}function load_tilemap_from_url(e){let t=new URL(e,document.baseURI);return console.log("loading tilemap from ",t),fetch(t).then(e=>e.json()).then(s=>{let r=[],o=[];return s.source=e,Promise.all(s.tilesets.map(e=>{if(!e.image){let e="tileset doesn't have an image. are you sure it's embedded";return void console.error(e)}return load_image_from_url(new URL(e.image,t)).then(t=>{let s=new SpriteSheet(t,e.tilewidth,e.tileheight),i=e.firstgid;for(let t=0;t<e.tilecount;t++)r[i]=s.sprite_to_image(t%e.columns,Math.floor(t/e.columns)),i++;e.tiles&&e.tiles.forEach(t=>{"floor"===t.type&&o.push(t.id+e.firstgid),"wall"===t.type&&o.push(t.id+e.firstgid),"block"===t.type&&o.push(t.id+e.firstgid)})})})).then(()=>(s.index=r,console.log("blocking is",o),s.wall_types=o,s))})}TileMapSystem.queries={screen:{components:[Canvas,Camera]},maps:{components:[TileMap]}};class KeyboardState extends Component{constructor(){super(),this.states={},this.mapping={" ":"jump",ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"},this.on_keydown=e=>{this.setKeyState(e.key,"down")},this.on_keyup=e=>{this.setKeyState(e.key,"up")}}setKeyState(e,t){let s=this.getKeyState(e);s.prev=s.current,s.current=t}getKeyState(e){return this.states[e]||(this.states[e]={prev:"up",current:"up"}),this.states[e]}isPressed(e){return"down"===this.getKeyState(e).current}}class KeyboardSystem extends System{execute(e,t){this.queries.controls.added.forEach(e=>{let t=e.getMutableComponent(KeyboardState);document.addEventListener("keydown",t.on_keydown),document.addEventListener("keyup",t.on_keyup)}),this.queries.controls.results.forEach(e=>{let t=e.getComponent(KeyboardState),s=e.getMutableComponent(InputState);s.changed=!1,s.released=!1,Object.keys(t.mapping).forEach(e=>{let r=t.mapping[e],o=t.getKeyState(e);"down"===o.current&&"up"===o.prev&&(s.states[r]="down"===o.current,s.changed=!0),"up"===o.current&&"down"===o.prev&&(s.states[r]="down"===o.current,s.changed=!0,s.released=!0),o.prev=o.current})})}}KeyboardSystem.queries={controls:{components:[KeyboardState,InputState],listen:{added:!0,removed:!0}}};class WaitForInput extends Component{constructor(){super(),this.started=!1}}class Dialog{constructor(){this.text="some text",this.tilemap=null,this.text_offset=make_point(0,0),this.text_color="black"}}class FixedWidthFont{constructor(){this.src=null,this.loaded=!1,this.image=null,this.lineHeight=7,this.charHeight=7,this.charWidth=4,this._debug_drawn=!1}drawCharCode(e,t){if(32===t)return this.charWidth;let s=0,r=0;return t>=65&&t<=90&&(s=t-65,r=Math.floor(s/16),s%=16),33===t&&(s=0,r=3),s>=0&&e.drawImage(this.image,s*this.charWidth,r*(this.height-1),this.charWidth,this.height,0,0,this.charWidth,this.height),this.charWidth}}class VariableWidthFont{constructor(){this.src=null,this.loaded=!1,this.image=null,this.charHeight=7,this.lineHeight=7,this.charWidth=4,this.charsPerLine=8,this._debug_drawn=!1,this.widths={},this.positions={}}drawCharCode(e,t){let s=this.charWidth;s=3;let r=String.fromCharCode(t);if(this.widths[r]&&(s=this.widths[r]),32===t)return s;let o=0,i=0;return t>=65&&t<=90&&(o=t-65,i=Math.floor(o/this.charsPerLine),o%=this.charsPerLine),t>=97&&t<=122&&(o=t-97,i=Math.floor(o/this.charsPerLine)+3,o%=this.charsPerLine),this.positions[r]&&(o=this.positions[r].x,i=this.positions[r].y),o>=0&&e.drawImage(this.image,o*this.charWidth,i*this.charHeight,s,this.charHeight,0,0,s,this.charHeight),s+1}}class DialogSystem extends System{execute(e,t){this.queries.fonts.added.forEach(e=>{this.loadImage(e.getMutableComponent(FixedWidthFont))}),this.queries.fonts2.added.forEach(e=>{this.loadImage(e.getMutableComponent(VariableWidthFont))}),this.queries.canvas.results.forEach(e=>{let t=e.getComponent(Canvas),s=t.dom.getContext("2d");s.imageSmoothingEnabled=!1,s.save(),s.scale(t.scale,t.scale),this.queries.dialogs.results.forEach(e=>{let r=e.getComponent(Dialog);if(r.tilemap?this.drawTilemap(s,r.tilemap):(s.fillStyle="yellow",s.fillRect(8,8,t.width-16,t.height-16)),s.save(),s.translate(r.text_offset.x,r.text_offset.y),e.hasComponent(FixedWidthFont)){let t=e.getComponent(FixedWidthFont),o=8;r.text.split("\n").forEach(e=>{this.drawLine(s,e,t,8,o),o+=t.lineHeight})}else if(e.hasComponent(VariableWidthFont)){let t=e.getComponent(VariableWidthFont),o=8;r.text.split("\n").forEach(e=>{this.drawLine(s,e,t,8,o),o+=t.lineHeight})}else{{s.fillStyle=r.text_color,s.font="6pt normal sans-serif";let e=8;r.text.split("\n").forEach(t=>{let r=s.measureText(t);e+=Math.floor(1.4*(r.actualBoundingBoxAscent+r.actualBoundingBoxDescent)),e+=1,s.fillText(t,10,e)})}s.restore()}}),s.restore()})}drawLine(e,t,s,r,o){for(let i=0;i<t.length;i++)s._debug_drawn||(s._debug_drawn=!0,console.log(t.charAt(i),t.charCodeAt(i))),e.save(),e.translate(r,o),r+=s.drawCharCode(e,t.charCodeAt(i)),e.restore()}drawTilemap(e,t){t.layers.forEach(s=>{this.drawTileLayer(t,e,s)})}drawTileLayer(e,t,s){for(let r=0;r<s.height;r++)for(let o=0;o<s.width;o++){let i=r*s.width+o,n=s.data[i];if(0===n)continue;let a=e.index[n];if(!a)throw new Error("missing tile "+n+" "+a);a&&t.drawImage(a,o*e.tilewidth,r*e.tileheight)}}loadImage(e){e.image||(e.image=new Image,e.image.onload=()=>{e.loaded=!0},e.image.src=e.src)}}DialogSystem.queries={canvas:{components:[Canvas]},dialogs:{components:[Dialog],listen:{added:!0}},fonts:{components:[FixedWidthFont],listen:{added:!0}},fonts2:{components:[VariableWidthFont],listen:{added:!0}}};class MouseState{constructor(){this.clientX=0,this.clientY=0}}class MouseInputSystem extends System{execute(e,t){this.queries.mouse.added.forEach(e=>{let t=e.getMutableComponent(MouseState);t.moveHandler=e=>{t.clientX=e.clientX,t.lastTimestamp=e.timeStamp},document.addEventListener("mousemove",t.moveHandler,!1)}),this.queries.mouse.results.forEach(e=>{}),this.queries.mouse.removed.forEach(e=>{let t=e.getMutableComponent(MouseState);document.removeEventListener("mousemove",t.moveHandler)})}}MouseInputSystem.queries={mouse:{components:[MouseState],listen:{added:!0,removed:!0}}};class FullscreenMode extends Component{}class FullscreenButton extends Component{}class FullscreenSystem extends System{execute(e,t){this.queries.buttons.added.forEach(e=>{let t=document.createElement("button");t.innerText="fullscreen",t.classList.add("fullscreen"),t.addEventListener("click",t=>{t.stopPropagation(),t.preventDefault(),e.addComponent(FullscreenMode)}),document.documentElement.append(t)}),this.queries.active.added.forEach(e=>{console.log("turned on full screen");let t=e.getMutableComponent(FullscreenMode);t.fullscreenchangeHandler=()=>{console.log("entered full screen"),document.fullscreenElement||document.webkitFullscreenElement?console.log("entered"):(console.log("exited"),e.removeComponent(FullscreenMode))},document.addEventListener("fullscreenchange",t.fullscreenchangeHandler),document.addEventListener("webkitfullscreenchange",t.fullscreenchangeHandler),document.querySelector("canvas").requestFullscreen()}),this.queries.active.removed.forEach(e=>{console.log("removed the fullscreen mode")})}}FullscreenSystem.queries={buttons:{components:[FullscreenButton],listen:{added:!0}},active:{components:[FullscreenMode],listen:{added:!0,removed:!0}}};class SoundEffect{constructor(){this.audio=null,this.src=null}}class PlaySoundEffect{}class AudioSystem extends System{execute(e,t){this.queries.sound_effects.added.forEach(e=>{let t=e.getComponent(SoundEffect);t.src&&!this.audio&&(t.audio=new Audio,console.log("loading the audio",t.src),t.audio.addEventListener("loadeddata",()=>{console.log("loaded audio from src",t.src)}),t.audio.src=t.src)}),this.queries.play.added.forEach(e=>{e.getComponent(SoundEffect).audio.play(),e.removeComponent(PlaySoundEffect)})}}AudioSystem.queries={sound_effects:{components:[SoundEffect],listen:{added:!0}},play:{components:[SoundEffect,PlaySoundEffect],listen:{added:!0}}},exports.AnimatedSprite=AnimatedSprite,exports.AudioSystem=AudioSystem,exports.BackgroundFill=BackgroundFill,exports.Camera=Camera,exports.CameraFollowsSprite=CameraFollowsSprite,exports.Canvas=Canvas,exports.DebugOutline=DebugOutline,exports.Dialog=Dialog,exports.DialogSystem=DialogSystem,exports.ECSYTwoSystem=ECSYTwoSystem,exports.FilledSprite=FilledSprite,exports.FullscreenButton=FullscreenButton,exports.FullscreenMode=FullscreenMode,exports.FullscreenSystem=FullscreenSystem,exports.ImageSprite=ImageSprite,exports.InputState=InputState,exports.KeyboardState=KeyboardState,exports.KeyboardSystem=KeyboardSystem,exports.MouseInputSystem=MouseInputSystem,exports.MouseState=MouseState,exports.PlaySoundEffect=PlaySoundEffect,exports.SoundEffect=SoundEffect,exports.Sprite=Sprite,exports.SpriteSheet=SpriteSheet,exports.SpriteSystem=SpriteSystem,exports.TileMap=TileMap,exports.TileMapSystem=TileMapSystem,exports.WaitForInput=WaitForInput,exports.load_image_from_url=load_image_from_url,exports.load_tilemap_from_url=load_tilemap_from_url,exports.make_point=make_point,exports.startWorld=startWorld,Object.defineProperty(exports,"__esModule",{value:!0})}));
