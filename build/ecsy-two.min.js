!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):(e=e||self,function(){var s=e.ECSYTwo,i=e.ECSYTwo={};t(i),i.noConflict=function(){return e.ECSYTwo=s,i}}())}(this,(function(exports){"use strict";class EventDispatcher{constructor(){this._listeners={},this.stats={fired:0,handled:0}}addEventListener(e,t){let s=this._listeners;void 0===s[e]&&(s[e]=[]),-1===s[e].indexOf(t)&&s[e].push(t)}hasEventListener(e,t){return void 0!==this._listeners[e]&&-1!==this._listeners[e].indexOf(t)}removeEventListener(e,t){var s=this._listeners[e];if(void 0!==s){var i=s.indexOf(t);-1!==i&&s.splice(i,1)}}dispatchEvent(e,t,s){this.stats.fired++;var i=this._listeners[e];if(void 0!==i)for(var r=i.slice(0),o=0;o<r.length;o++)r[o].call(this,t,s)}resetCounters(){this.stats.fired=this.stats.handled=0}}function getName(e){return e.name}function queryKey(e){for(var t=[],s=0;s<e.length;s++){var i=e[s];if("object"==typeof i){var r="not"===i.operator?"!":i.operator;t.push(r+getName(i.Component))}else t.push(getName(i))}return t.sort().join("-")}class Query{constructor(e,t){if(this.Components=[],this.NotComponents=[],e.forEach(e=>{"object"==typeof e?this.NotComponents.push(e.Component):this.Components.push(e)}),0===this.Components.length)throw new Error("Can't create a query without components");this.entities=[],this.eventDispatcher=new EventDispatcher,this.reactive=!1,this.key=queryKey(e);for(var s=0;s<t._entities.length;s++){var i=t._entities[s];this.match(i)&&(i.queries.push(this),this.entities.push(i))}}addEntity(e){e.queries.push(this),this.entities.push(e),this.eventDispatcher.dispatchEvent(Query.prototype.ENTITY_ADDED,e)}removeEntity(e){let t=this.entities.indexOf(e);~t&&(this.entities.splice(t,1),t=e.queries.indexOf(this),e.queries.splice(t,1),this.eventDispatcher.dispatchEvent(Query.prototype.ENTITY_REMOVED,e))}match(e){return e.hasAllComponents(this.Components)&&!e.hasAnyComponents(this.NotComponents)}toJSON(){return{key:this.key,reactive:this.reactive,components:{included:this.Components.map(e=>e.name),not:this.NotComponents.map(e=>e.name)},numEntities:this.entities.length}}stats(){return{numComponents:this.Components.length,numEntities:this.entities.length}}}Query.prototype.ENTITY_ADDED="Query#ENTITY_ADDED",Query.prototype.ENTITY_REMOVED="Query#ENTITY_REMOVED",Query.prototype.COMPONENT_CHANGED="Query#COMPONENT_CHANGED";class System{canExecute(){if(0===this._mandatoryQueries.length)return!0;for(let e=0;e<this._mandatoryQueries.length;e++){if(0===this._mandatoryQueries[e].entities.length)return!1}return!0}constructor(e,t){if(this.world=e,this.enabled=!0,this._queries={},this.queries={},this.priority=0,this.executeTime=0,t&&t.priority&&(this.priority=t.priority),this._mandatoryQueries=[],this.initialized=!0,this.constructor.queries)for(var s in this.constructor.queries){var i=this.constructor.queries[s],r=i.components;if(!r||0===r.length)throw new Error("'components' attribute can't be empty in a query");var o=this.world.entityManager.queryComponents(r);this._queries[s]=o,!0===i.mandatory&&this._mandatoryQueries.push(o),this.queries[s]={results:o.entities};const e={added:Query.prototype.ENTITY_ADDED,removed:Query.prototype.ENTITY_REMOVED,changed:Query.prototype.COMPONENT_CHANGED};i.listen&&["added","removed","changed"].forEach(t=>{if(i.listen[t]){let r=i.listen[t];if("changed"===t){if(o.reactive=!0,!0===r){let e=this.queries[s][t]=[];o.eventDispatcher.addEventListener(Query.prototype.COMPONENT_CHANGED,t=>{-1===e.indexOf(t)&&e.push(t)})}else if(Array.isArray(r)){let e=this.queries[s][t]=[];o.eventDispatcher.addEventListener(Query.prototype.COMPONENT_CHANGED,(t,s)=>{-1!==r.indexOf(s.constructor)&&-1===e.indexOf(t)&&e.push(t)})}}else{let i=this.queries[s][t]=[];o.eventDispatcher.addEventListener(e[t],e=>{-1===i.indexOf(e)&&i.push(e)})}}})}}stop(){this.executeTime=0,this.enabled=!1}play(){this.enabled=!0}clearEvents(){for(let t in this.queries){var e=this.queries[t];if(e.added&&(e.added.length=0),e.removed&&(e.removed.length=0),e.changed)if(Array.isArray(e.changed))e.changed.length=0;else for(let t in e.changed)e.changed[t].length=0}}toJSON(){var e={name:this.constructor.name,enabled:this.enabled,executeTime:this.executeTime,priority:this.priority,queries:{}};if(this.constructor.queries){var t=this.constructor.queries;for(let s in t){let i=this.queries[s],r=t[s],o=e.queries[s]={key:this._queries[s].key};if(o.mandatory=!0===r.mandatory,o.reactive=r.listen&&(!0===r.listen.added||!0===r.listen.removed||!0===r.listen.changed||Array.isArray(r.listen.changed)),o.reactive){o.listen={},["added","removed","changed"].forEach(e=>{i[e]&&(o.listen[e]={entities:i[e].length})})}}}return e}}class Component{}function createType(e){var t=["create","reset","clear"].filter(t=>!e[t]);if(t.length>0)throw new Error("createType expect type definition to implements the following functions: "+t.join(", "));return e.isType=!0,e}Component.isComponent=!0;var Types={};function generateId(e){for(var t="",s="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",i=s.length,r=0;r<e;r++)t+=s.charAt(Math.floor(Math.random()*i));return t}function injectScript(e,t){var s=document.createElement("script");s.src=e,s.onload=t,(document.head||document.documentElement).appendChild(s)}function hookConsoleAndErrors(e){["error","warning","log"].forEach(t=>{if("function"==typeof console[t]){var s=console[t].bind(console);console[t]=(...i)=>(e.send({method:"console",type:t,args:JSON.stringify(i)}),s.apply(null,i))}}),window.addEventListener("error",t=>{e.send({method:"error",error:JSON.stringify({message:t.error.message,stack:t.error.stack})})})}function includeRemoteIdHTML(e){let t=document.createElement("div");return t.style.cssText="\n    align-items: center;\n    background-color: #333;\n    color: #aaa;\n    display:flex;\n    font-family: Arial;\n    font-size: 1.1em;\n    height: 40px;\n    justify-content: center;\n    left: 0;\n    opacity: 0.9;\n    position: absolute;\n    right: 0;\n    text-align: center;\n    top: 0;\n  ",t.innerHTML=`Open ECSY devtools to connect to this page using the code:&nbsp;<b style="color: #fff">${e}</b>&nbsp;<button onClick="generateNewCode()">Generate new code</button>`,document.body.appendChild(t),t}function enableRemoteDevtools(remoteId){window.generateNewCode=()=>{window.localStorage.clear(),remoteId=generateId(6),window.localStorage.setItem("ecsyRemoteId",remoteId),window.location.reload(!1)},remoteId=remoteId||window.localStorage.getItem("ecsyRemoteId"),remoteId||(remoteId=generateId(6),window.localStorage.setItem("ecsyRemoteId",remoteId));let infoDiv=includeRemoteIdHTML(remoteId);window.__ECSY_REMOTE_DEVTOOLS_INJECTED=!0,window.__ECSY_REMOTE_DEVTOOLS={};let Version="",worldsBeforeLoading=[],onWorldCreated=e=>{var t=e.detail.world;Version=e.detail.version,worldsBeforeLoading.push(t)};window.addEventListener("ecsy-world-created",onWorldCreated);let onLoaded=()=>{var peer=new Peer(remoteId);peer.on("open",()=>{peer.on("connection",connection=>{window.__ECSY_REMOTE_DEVTOOLS.connection=connection,connection.on("open",(function(){infoDiv.innerHTML="Connected",connection.on("data",(function(data){if("init"===data.type){var script=document.createElement("script");script.setAttribute("type","text/javascript"),script.onload=()=>{script.parentNode.removeChild(script),window.removeEventListener("ecsy-world-created",onWorldCreated),worldsBeforeLoading.forEach(e=>{var t=new CustomEvent("ecsy-world-created",{detail:{world:e,version:Version}});window.dispatchEvent(t)})},script.innerHTML=data.script,(document.head||document.documentElement).appendChild(script),script.onload(),hookConsoleAndErrors(connection)}else if("executeScript"===data.type){let value=eval(data.script);data.returnEval&&connection.send({method:"evalReturn",value:value})}}))}))})})};injectScript("https://cdn.jsdelivr.net/npm/peerjs@0.3.20/dist/peer.min.js",onLoaded)}Types.Number=createType({baseType:Number,isSimpleType:!0,create:e=>void 0!==e?e:0,reset:(e,t,s)=>{e[t]=void 0!==s?s:0},clear:(e,t)=>{e[t]=0}}),Types.Boolean=createType({baseType:Boolean,isSimpleType:!0,create:e=>void 0!==e&&e,reset:(e,t,s)=>{e[t]=void 0!==s&&s},clear:(e,t)=>{e[t]=!1}}),Types.String=createType({baseType:String,isSimpleType:!0,create:e=>void 0!==e?e:"",reset:(e,t,s)=>{e[t]=void 0!==s?s:""},clear:(e,t)=>{e[t]=""}}),Types.Array=createType({baseType:Array,create:e=>void 0!==e?e.slice():[],reset:(e,t,s)=>{void 0!==s?e[t]=s.slice():e[t].length=0},clear:(e,t)=>{e[t].length=0},copy:(e,t,s)=>{e[s]=t[s].slice()}});const urlParams=new URLSearchParams(window.location.search);urlParams.has("enable-remote-devtools")&&enableRemoteDevtools();class Canvas extends Component{constructor(){super(),this.scale=1,this.dom=null,this.pixelMode=!1,this.width=100,this.height=100}}class BackgroundFill extends Component{constructor(){super(),this.color="white"}}class Camera extends Component{constructor(){super(),this.x=0,this.y=0,this.centered=!0}}class CameraFollowsSprite extends Component{constructor(){super(),this.target=null}}class Sprite extends Component{constructor(){super(),this.x=0,this.y=0,this.width=10,this.height=10,this.layer="default",this.draw_object=null}left(){return this.x}right(){return this.x+this.width}top(){return this.y}bottom(){return this.y+this.height}intersects(e){return this.right()>=e.left()&&this.left()<=e.right()&&this.top()<=e.bottom()&&this.bottom()>=e.top()}union(e){let t=new Sprite,s=this;return t.x=Math.min(s.x,e.x),t.y=Math.min(s.y,e.y),t.width=Math.max(s.right(),e.right())-Math.min(s.left(),e.left()),t.height=Math.max(s.bottom(),e.bottom())-Math.min(s.top(),e.top()),t}contains(e){return!(this.left()>e.x)&&(!(this.right()<e.x)&&(!(this.top()>e.y)&&!(this.bottom()<e.y)))}}class DebugOutline{constructor(){this.color="red"}}class FilledSprite extends Component{constructor(){super(),this.color="red"}}class InputState extends Component{constructor(){super(),this.states={},this.changed=!0,this.released=!1}anyChanged(){return this.changed}anyReleased(){return this.released}}class ECSYTwoSystem extends System{execute(e,t){this.queries.canvas.added.forEach(e=>{let t=e.getMutableComponent(Canvas);t.dom=document.createElement("canvas"),t.dom.width=t.width*t.scale,t.dom.height=t.height*t.scale,document.body.append(t.dom)}),this.queries.canvas.results.forEach(e=>{let t=e.getComponent(Canvas),s=t.dom.getContext("2d");s.imageSmoothingEnabled=!t.pixelMode,s.save(),s.scale(t.scale,t.scale),this.queries.background.results.forEach(e=>{let i=e.getComponent(BackgroundFill);s.fillStyle=i.color,s.fillRect(0,0,t.dom.width,t.dom.height)}),s.restore()}),this.queries.inputs.results.forEach(e=>{let t=e.getMutableComponent(InputState);t.changed=!1,t.released=!1})}}function startWorld(e){let t=performance.now();!function s(){const i=performance.now(),r=i-t;e.execute(r,i),t=i,requestAnimationFrame(s)}()}ECSYTwoSystem.queries={canvas:{components:[Canvas],listen:{added:!0}},background:{components:[BackgroundFill]},inputs:{components:[InputState]}};class Layer extends Component{constructor(){super(),this.name="unnamed-layer",this.depth=1e5}}class LayerParent extends Component{constructor(){super(),this.name="default",this.draw_object=null}}class LayerRenderingSystem extends System{init(){this.layer_order=[],this.layer_index={}}execute(e,t){this.queries.canvas.added.forEach(e=>{e.addComponent(Layer,{name:"default",depth:0})}),this.update_layer_order(),this.update_layer_index(),this.draw_layers()}update_layer_order(){this.layer_order=this.queries.layers.results.map(e=>e.getComponent(Layer)),this.layer_order.sort((e,t)=>e.depth-t.depth)}update_layer_index(){this.layer_index={},this.queries.layer_children.results.forEach(e=>{let t=e.getComponent(LayerParent);this.layer_index[t.name]||(this.layer_index[t.name]=[]),t.draw_object&&this.layer_index[t.name].push(t.draw_object)}),this.queries.sprite_children.results.forEach(e=>{let t=e.getComponent(Sprite);this.layer_index[t.layer]||(this.layer_index[t.layer]=[]),t.draw_object&&this.layer_index[t.layer].push(t.draw_object)})}draw_layers(){this.queries.canvas.results.forEach(e=>{let t=e.getComponent(Canvas),s=t.dom.getContext("2d");if(s.save(),s.scale(t.scale,t.scale),e.hasComponent(Camera)){let i=e.getComponent(Camera);i.centered&&s.translate(-i.x+t.width/2,-i.y+t.height/2)}this.layer_order.forEach(t=>{let i=this.layer_index[t.name];i&&i.forEach(t=>t.draw(s,e))}),s.restore()})}}LayerRenderingSystem.queries={canvas:{components:[Canvas],listen:{added:!0}},layers:{components:[Layer]},layer_children:{components:[LayerParent]},sprite_children:{components:[Sprite]}};class DrawFilledRect{constructor(e,t){this.bounds=e,this.color=t}draw(e,t){if(e.save(),this.bounds.fixed&&t.hasComponent(Camera)){let s=t.getComponent(Canvas),i=t.getComponent(Camera);e.translate(+i.x-s.width/2,+i.y-s.height/2)}e.fillStyle=this.color,e.fillRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height),e.restore()}}class DrawStrokedRect{constructor(e,t){this.bounds=e,this.color=t}draw(e){e.strokeStyle=this.color,e.strokeRect(this.bounds.x,this.bounds.y,this.bounds.width,this.bounds.height)}}class DrawImage{constructor(e,t){this.bounds=e,this.sprite=t}draw(e,t){if(this.sprite&&this.sprite.image){if(e.save(),this.sprite.flipY&&(e.scale(-1,1),e.translate(-this.sprite.width,0)),this.bounds.fixed&&t.hasComponent(Camera)){let s=t.getComponent(Canvas),i=t.getComponent(Camera);e.translate(+i.x-s.width/2,+i.y-s.height/2)}e.translate(this.bounds.x,this.bounds.y),e.drawImage(this.sprite.image,0,0),e.restore()}}}class ImageSprite extends Component{constructor(){super(),this.image=null,this.src=null}}class AnimatedSprite extends Component{constructor(){super(),this.image=null,this.frame_count=1,this.current_frame=0,this.width=-1,this.height=-1,this.frame_duration=250,this.last_frame_time=0,this.src=null,this.frame_width=16}}class SpriteSystem extends System{execute(e,t){this.queries.canvas.results.forEach(e=>{let s=e.getComponent(Canvas),i=s.dom.getContext("2d");if(i.imageSmoothingEnabled=!1,i.save(),i.scale(s.scale,s.scale),e.hasComponent(Camera)){let t=e.getComponent(Camera);t.centered&&i.translate(-t.x+s.width/2,-t.y+s.height/2)}this.queries.sprites.added.forEach(e=>{let t=e.getComponent(ImageSprite);!t.image&&t.src&&(t.image=new Image,t.image.src=t.src)}),this.queries.animated_sprites.added.forEach(e=>{let t=e.getComponent(AnimatedSprite);!t.frames&&t.src&&(t.image=new Image,t.image.src=t.src)}),this.queries.filled_sprites.results.forEach(e=>{let t=e.getComponent(Sprite),s=e.getComponent(FilledSprite);t.draw_object=new DrawFilledRect(t,s.color)}),this.queries.sprites.results.forEach(e=>{let t=e.getComponent(Sprite),s=e.getComponent(ImageSprite);t.draw_object=new DrawImage(t,s)}),this.queries.animated_sprites.results.forEach(e=>{let s=e.getMutableComponent(AnimatedSprite);t-s.last_frame_time>s.frame_duration&&(s.current_frame=(s.current_frame+1)%s.frame_count,s.last_frame_time=t);let r=e.getComponent(Sprite);i.save(),i.translate(r.x,r.y),s.flipY&&(i.scale(-1,1),i.translate(-s.width,0)),i.drawImage(s.image,s.width*s.current_frame,0,s.width,s.height,0,0,s.width,s.height),i.restore()}),this.queries.debug_sprites.results.forEach(e=>{let t=e.getComponent(Sprite),s=e.getComponent(DebugOutline);t.draw_object=new DrawStrokedRect(t,s.color),i.strokeStyle=s.color,i.strokeRect(t.x,t.y,t.width,t.height)}),i.restore()}),this.queries.camera_move.results.forEach(e=>{let t=e.getComponent(CameraFollowsSprite);if(!t.target)return;let s=t.target.getComponent(Sprite);s&&this.queries.canvas.results.forEach(e=>{if(e.hasComponent(Camera)){let t=e.getMutableComponent(Camera);t.x=s.x,t.y=s.y}})})}}SpriteSystem.queries={canvas:{components:[Canvas]},sprites:{components:[Sprite,ImageSprite],listen:{added:!0,removed:!0}},camera_move:{components:[CameraFollowsSprite]},animated_sprites:{components:[Sprite,AnimatedSprite],listen:{added:!0,removed:!0}},filled_sprites:{components:[Sprite,FilledSprite]},debug_sprites:{components:[Sprite,DebugOutline]}};class SpriteSheet{constructor(e,t,s){this.image=e,this.tw=t,this.th=s}sprite_to_image(e,t){let s=document.createElement("canvas");return s.width=this.tw,s.height=this.th,s.getContext("2d").drawImage(this.image,e*this.tw,t*this.th,this.tw,this.th,0,0,this.tw,this.th),s}sprites_to_frames(e,t,s){let i=[];for(let r=0;r<s;r++)i.push(this.sprite_to_image(e+r,t));return i}drawSpriteAt(e,t,s,i,r){e.drawImage(this.image,t*this.tw,s*this.th,this.tw,this.th,i,r,this.tw,this.th)}}function load_image_from_url(e){return new Promise((t,s)=>{let i=document.createElement("img");i.onload=()=>{t(i)},i.onerror=()=>s(i),i.src=e})}class KeyboardState extends Component{constructor(){super(),this.states={},this.mapping={" ":"jump",ArrowLeft:"left",ArrowRight:"right",ArrowUp:"up",ArrowDown:"down"},this.on_keydown=e=>{this.setKeyState(e.key,"down")},this.on_keyup=e=>{this.setKeyState(e.key,"up")}}setKeyState(e,t){let s=this.getKeyState(e);s.prev=s.current,s.current=t}getKeyState(e){return this.states[e]||(this.states[e]={prev:"up",current:"up"}),this.states[e]}isPressed(e){return"down"===this.getKeyState(e).current}}class KeyboardSystem extends System{execute(e,t){this.queries.controls.added.forEach(e=>{let t=e.getMutableComponent(KeyboardState);document.addEventListener("keydown",t.on_keydown),document.addEventListener("keyup",t.on_keyup)}),this.queries.controls.results.forEach(e=>{let t=e.getComponent(KeyboardState),s=e.getMutableComponent(InputState);Object.keys(t.mapping).forEach(e=>{let i=t.mapping[e],r=t.getKeyState(e);"down"===r.current&&"up"===r.prev&&(s.states[i]="down"===r.current,s.changed=!0),"up"===r.current&&"down"===r.prev&&(s.states[i]="down"===r.current,s.changed=!0,s.released=!0),r.prev=r.current})})}}KeyboardSystem.queries={controls:{components:[KeyboardState,InputState],listen:{added:!0,removed:!0}}};const BUTTONS={LEFT:"left-button",PRESSED:"down",RELEASED:"up"};class MouseState{constructor(){this.clientX=0,this.clientY=0,this.states={},this.downHandler=e=>{this.setKeyState(BUTTONS.LEFT,BUTTONS.PRESSED)},this.moveHandler=e=>{this.clientX=e.clientX,this.lastTimestamp=e.timeStamp},this.upHandler=e=>{this.setKeyState(BUTTONS.LEFT,BUTTONS.RELEASED)}}setKeyState(e,t){let s=this.getKeyState(e);s.prev=s.current,s.current=t}getKeyState(e){return this.states[e]||(this.states[e]={prev:BUTTONS.RELEASED,current:BUTTONS.RELEASED}),this.states[e]}}class MouseInputSystem extends System{execute(e,t){this.queries.mouse.added.forEach(e=>{let t=e.getMutableComponent(MouseState);document.addEventListener("mousemove",t.moveHandler,!1),document.addEventListener("mousedown",t.downHandler,!1),document.addEventListener("mouseup",t.upHandler,!1)}),this.queries.mouse.results.forEach(e=>{let t=e.getComponent(MouseState),s=e.getMutableComponent(InputState),i=BUTTONS.LEFT,r=t.getKeyState(i);r.current===BUTTONS.PRESSED&&r.prev===BUTTONS.RELEASED&&(s.states[i]=r.current===BUTTONS.PRESSED,s.changed=!0),r.current===BUTTONS.RELEASED&&r.prev===BUTTONS.PRESSED&&(s.states[i]=r.current===BUTTONS.PRESSED,s.changed=!0,s.released=!0),r.prev=r.current}),this.queries.mouse.removed.forEach(e=>{let t=e.getMutableComponent(MouseState);t&&document.removeEventListener("mousemove",t.moveHandler)})}}function make_point(e,t){return{x:e,y:t,div:function(e){return make_point(this.x/e,this.y/e)}}}MouseInputSystem.queries={mouse:{components:[MouseState,InputState],listen:{added:!0,removed:!0}}};class FullscreenMode extends Component{}class FullscreenButton extends Component{}class FullscreenSystem extends System{execute(e,t){this.queries.buttons.added.forEach(e=>{let t=document.createElement("button");t.innerText="fullscreen",t.classList.add("fullscreen"),t.addEventListener("click",t=>{t.stopPropagation(),t.preventDefault(),e.addComponent(FullscreenMode)}),document.documentElement.append(t)}),this.queries.active.added.forEach(e=>{console.log("turned on full screen");let t=e.getMutableComponent(FullscreenMode);t.fullscreenchangeHandler=()=>{console.log("entered full screen"),document.fullscreenElement||document.webkitFullscreenElement?console.log("entered"):(console.log("exited"),e.removeComponent(FullscreenMode))},document.addEventListener("fullscreenchange",t.fullscreenchangeHandler),document.addEventListener("webkitfullscreenchange",t.fullscreenchangeHandler),document.querySelector("canvas").requestFullscreen()}),this.queries.active.removed.forEach(e=>{console.log("removed the fullscreen mode")})}}FullscreenSystem.queries={buttons:{components:[FullscreenButton],listen:{added:!0}},active:{components:[FullscreenMode],listen:{added:!0,removed:!0}}};class SoundEffect{constructor(){this.audio=null,this.src=null,this.volume=1}}class BackgroundMusic{constructor(){this.audio=null,this.src=null,this.volume=.5}}class PlaySoundEffect{}class AudioEnabled{}class AudioSystem extends System{init(){this.audioReady=!1,this.callbacks=[],window.addEventListener("touchstart",()=>this.startAudio()),window.addEventListener("touchend",()=>this.startAudio()),window.addEventListener("click",()=>this.startAudio())}execute(e,t){this.queries.sound_effects.added.forEach(e=>{let t=e.getComponent(SoundEffect);t.src&&!this.audio&&(t.audio=new Audio,console.log("loading the audio",t.src),t.audio.addEventListener("loadeddata",()=>{console.log("loaded audio from src",t.src),t.audio.volume=t.volume}),t.audio.src=t.src)}),this.queries.music.added.forEach(e=>{this.whenReady(()=>this.start_background_music(e))}),this.queries.music.removed.forEach(e=>{this.stop_background_music(e)}),this.queries.play.added.forEach(e=>{this.whenReady(()=>this.play_soundeffect(e))})}whenReady(e){this.audioReady?e():this.callbacks.push(e)}startAudio(){if(!this.audioReady){if(console.log("initing audio"),this.audioReady=!0,window.AudioContext=window.AudioContext||window.webkitAudioContext,window.AudioContext){this.context=new window.AudioContext;var e=this.context.createBuffer(1,1,22050),t=this.context.createBufferSource();t.buffer=e,t.connect(this.context.destination),t.start?t.start(0):t.play?t.play(0):t.noteOn&&t.noteOn(0)}this.world.createEntity().addComponent(AudioEnabled),this.callbacks.forEach(e=>e()),this.callbacks=null,this.log("audio enabled")}}log(e){console.log("LOG: ",e);const t=document.querySelector("#info-alert");t&&(t.innerHTML=e)}start_background_music(e){let t=e.getComponent(BackgroundMusic);t.src&&!this.audio&&(t.audio=new Audio,console.log("starting the background music"),t.audio.loop=!0,t.audio.volume=t.volume,console.log("loading the audio",t.src),t.audio.addEventListener("loadeddata",()=>{console.log("loaded audio from src",t.src),t.audio.play()}),t.audio.src=t.src)}stop_background_music(e){let t=e.getComponent(BackgroundMusic);t&&t.audio&&t.audio.pause()}play_soundeffect(e){e.getComponent(SoundEffect).audio.play(),e.removeComponent(PlaySoundEffect)}}AudioSystem.queries={sound_effects:{components:[SoundEffect],listen:{added:!0}},music:{components:[BackgroundMusic],listen:{added:!0,removed:!0}},play:{components:[SoundEffect,PlaySoundEffect],listen:{added:!0}}};class SimpleGamepadState extends Component{constructor(){super(),this.axis_threshold=.4,this.connected=!1}}class GamepadSystem extends System{execute(e,t){this.queries.simple.added.forEach(e=>{let t=e.getMutableComponent(SimpleGamepadState);window.addEventListener("gamepadconnected",e=>{console.log("A gamepad connected:",e.gamepad),t.connected=!0}),window.addEventListener("gamepaddisconnected",e=>{console.log("A gamepad disconnected:",e.gamepad),t.connected=!1})}),this.queries.simple.results.forEach(e=>{let t=e.getMutableComponent(SimpleGamepadState);t.connected&&this._scan_gamepads(t,e.getMutableComponent(InputState))})}_scan_gamepads(e,t){navigator.getGamepads().forEach(s=>{s.axes&&s.axes.length>=2&&(this.scan_x(e,s.axes[0],t),this.scan_y(e,s.axes[1],t))})}scan_x(e,t,s){return t<-e.axis_threshold?(s.states.left=!0,void(s.states.right=!1)):t>e.axis_threshold?(s.states.left=!1,void(s.states.right=!0)):(s.states.left=!1,void(s.states.right=!1))}scan_y(e,t,s){return t<-e.axis_threshold?(s.states.up=!1,void(s.states.down=!0)):t>e.axis_threshold?(s.states.up=!0,void(s.states.down=!1)):(s.states.up=!1,void(s.states.down=!1))}}GamepadSystem.queries={simple:{components:[SimpleGamepadState,InputState],listen:{added:!0,removed:!0}}};const FLIPPED_HORIZONTALLY_FLAG=2147483648,FLIPPED_VERTICALLY_FLAG=1073741824,FLIPPED_DIAGONALLY_FLAG=536870912;function is_flipped_horizontally(e){return 0!=(e&FLIPPED_HORIZONTALLY_FLAG)}class TileMap extends Component{constructor(){super(),this.src=null,this.tilewidth=16,this.tileheight=16,this.width=-1,this.height=-1,this.layers=[],this.index=[],this.wall_types=[]}tile_at(e,t){let s=this.layer_by_name(e),i=make_point(Math.floor(t.x/this.tilewidth),Math.floor(t.y/this.tilewidth));return s&&"tilelayer"===s.type?s.data[i.y*this.width+i.x]:null}set_tile_at(e,t,s){return this.layer_by_name(e).data[t.y*this.width+t.x]=s}layer_by_name(e){return this.layers.find(t=>t.name===e)}}class TileMapSystem extends System{execute(e,t){this.queries.maps.added.forEach(e=>{let t=e.getComponent(TileMap);e.getComponent(LayerParent).draw_object={draw:e=>{this.drawMap(t,e)}},t.src&&load_tilemap_from_url(t.src).then(e=>{Object.keys(e).forEach(s=>{t[s]=e[s]})})})}drawMap(e,t){e.layers.forEach(s=>{"tilelayer"===s.type&&this.drawTileLayer(e,t,s),"objectgroup"===s.type&&this.drawObjectLayer(e,t,s)})}drawTileLayer(e,t,s){for(let i=0;i<s.height;i++)for(let r=0;r<s.width;r++){let o=i*s.width+r,n=s.data[o],a=n&~(FLIPPED_HORIZONTALLY_FLAG|FLIPPED_VERTICALLY_FLAG|FLIPPED_DIAGONALLY_FLAG);if(0===a)continue;let d=e.index[a];if(d||console.error("missing tile "+a+" "+d),!d)throw new Error("missing tile "+a+" "+d);d&&(t.save(),t.translate(r*e.tilewidth,i*e.tileheight),is_flipped_horizontally(n)&&(t.scale(-1,1),t.translate(-e.tilewidth,0)),t.drawImage(d,0,0),t.restore())}}drawObjectLayer(e,t,s){s.objects.forEach(s=>{if(s.gid){let i=e.index[s.gid];if(!i)throw new Error("missing tile "+s.gid+" "+i);i&&t.drawImage(i,s.x,s.y-s.height)}})}}function load_tilemap_from_url(e){let t=new URL(e,document.baseURI);return fetch(t).then(e=>e.json()).then(s=>{let i=[],r=[];return s.source=e,Promise.all(s.tilesets.map(e=>{if(!e.image){let e="tileset doesn't have an image. are you sure it's embedded";return void console.error(e)}return load_image_from_url(new URL(e.image,t)).then(t=>{let s=new SpriteSheet(t,e.tilewidth,e.tileheight),o=e.firstgid;for(let t=0;t<e.tilecount;t++)i[o]=s.sprite_to_image(t%e.columns,Math.floor(t/e.columns)),o++;e.tiles&&e.tiles.forEach(t=>{"floor"===t.type&&r.push(t.id+e.firstgid),"wall"===t.type&&r.push(t.id+e.firstgid),"block"===t.type&&r.push(t.id+e.firstgid)})})})).then(()=>(s.index=i,s.wall_types=r,s))})}TileMapSystem.queries={screen:{components:[Canvas,Camera]},maps:{components:[TileMap,LayerParent],listen:{added:!0,removed:!0}}};class WaitForInput extends Component{constructor(){super(),this.started=!1}}class Dialog{constructor(){this.text="some text",this.tilemap=null,this.text_offset=make_point(0,0),this.text_color="black"}}class FixedWidthFont{constructor(){this.src=null,this.loaded=!1,this.image=null,this.lineHeight=7,this.charHeight=7,this.charWidth=4,this._debug_drawn=!1}drawCharCode(e,t){if(32===t)return this.charWidth;let s=0,i=0;return t>=65&&t<=90&&(s=t-65,i=Math.floor(s/16),s%=16),33===t&&(s=0,i=3),s>=0&&e.drawImage(this.image,s*this.charWidth,i*(this.height-1),this.charWidth,this.height,0,0,this.charWidth,this.height),this.charWidth}}class VariableWidthFont{constructor(){this.src=null,this.loaded=!1,this.image=null,this.charHeight=7,this.lineHeight=7,this.charWidth=4,this.charsPerLine=8,this._debug_drawn=!1,this.widths={},this.positions={}}drawCharCode(e,t){let s=this.charWidth;s=3;let i=String.fromCharCode(t);if(this.widths[i]&&(s=this.widths[i]),32===t)return s;let r=0,o=0;return t>=65&&t<=90&&(r=t-65,o=Math.floor(r/this.charsPerLine),r%=this.charsPerLine),t>=97&&t<=122&&(r=t-97,o=Math.floor(r/this.charsPerLine)+3,r%=this.charsPerLine),this.positions[i]&&(r=this.positions[i].x,o=this.positions[i].y),r>=0&&e.drawImage(this.image,r*this.charWidth,o*this.charHeight,s,this.charHeight,0,0,s,this.charHeight),s+1}}class DialogSystem extends System{execute(e,t){this.queries.fonts.added.forEach(e=>{this.loadImage(e.getMutableComponent(FixedWidthFont))}),this.queries.fonts2.added.forEach(e=>{this.loadImage(e.getMutableComponent(VariableWidthFont))}),this.queries.canvas.results.forEach(e=>{let t=e.getComponent(Canvas),s=t.dom.getContext("2d");s.imageSmoothingEnabled=!1,s.save(),s.scale(t.scale,t.scale),this.queries.dialogs.results.forEach(e=>{let i=e.getComponent(Dialog);if(i.tilemap?this.drawTilemap(s,i.tilemap):(s.fillStyle="yellow",s.fillRect(8,8,t.width-16,t.height-16)),s.save(),s.translate(i.text_offset.x,i.text_offset.y),e.hasComponent(FixedWidthFont)){let t=e.getComponent(FixedWidthFont),r=8;i.text.split("\n").forEach(e=>{this.drawLine(s,e,t,8,r),r+=t.lineHeight})}else if(e.hasComponent(VariableWidthFont)){let t=e.getComponent(VariableWidthFont),r=8;i.text.split("\n").forEach(e=>{this.drawLine(s,e,t,8,r),r+=t.lineHeight})}else{{s.fillStyle=i.text_color,s.font="6pt normal sans-serif";let e=8;i.text.split("\n").forEach(t=>{let i=s.measureText(t);e+=Math.floor(1.4*(i.actualBoundingBoxAscent+i.actualBoundingBoxDescent)),e+=1,s.fillText(t,10,e)})}s.restore()}}),s.restore()})}drawLine(e,t,s,i,r){for(let o=0;o<t.length;o++)s._debug_drawn||(s._debug_drawn=!0,console.log(t.charAt(o),t.charCodeAt(o))),e.save(),e.translate(i,r),i+=s.drawCharCode(e,t.charCodeAt(o)),e.restore()}drawTilemap(e,t){t.layers.forEach(s=>{this.drawTileLayer(t,e,s)})}drawTileLayer(e,t,s){for(let i=0;i<s.height;i++)for(let r=0;r<s.width;r++){let o=i*s.width+r,n=s.data[o];if(0===n)continue;let a=e.index[n];if(!a)throw new Error("missing tile "+n+" "+a);a&&t.drawImage(a,r*e.tilewidth,i*e.tileheight)}}loadImage(e){e.image||(e.image=new Image,e.image.onload=()=>{e.loaded=!0},e.image.src=e.src)}}DialogSystem.queries={canvas:{components:[Canvas]},dialogs:{components:[Dialog],listen:{added:!0}},fonts:{components:[FixedWidthFont],listen:{added:!0}},fonts2:{components:[VariableWidthFont],listen:{added:!0}}};class Emitter extends Component{constructor(){super(),this.image=null,this.count=0,this.velocity=0,this.velocity_jitter=0,this.angle=0,this.angle_jitter=0,this.lifetime=2,this.duration=-1,this.start_time=0,this.tick_rate=50,this.count=0}}class Particle extends Component{constructor(){super(),this.start_time=0,this.lifetime=0,this.vx=0,this.vy=0}}class ParticleSystem extends System{execute(e,t){this.queries.emitters.added.forEach(e=>{e.getComponent(Emitter).start_time=t/1e3}),this.queries.emitters.results.forEach(e=>{let s=e.getComponent(Emitter),i=e.getComponent(Sprite);if(s.count++,s.count%s.tick_rate==0){let e=this.world.createEntity(),r=s.velocity+Math.random()*s.velocity_jitter,o=s.angle+Math.random()*s.angle_jitter;e.addComponent(Particle,{vx:Math.sin(o)*r,vy:Math.cos(o)*r,lifetime:s.lifetime,start_time:t/1e3}),e.addComponent(Sprite,{x:i.x,y:i.y,width:i.width,height:i.height,layer:i.layer}),s.emit?s.emit(e):s.image?e.addComponent(ImageSprite,{image:s.image}):e.addComponent(FilledSprite,{color:"yellow"})}-1!==s.duration&&t/1e3-s.start_time>s.duration&&e.removeComponent(Emitter)}),this.queries.particles.results.forEach(s=>{let i=s.getComponent(Particle),r=s.getMutableComponent(Sprite);r.x+=i.vx*e/1e3,r.y+=i.vy*e/1e3,t/1e3>i.start_time+i.lifetime&&(s.removeAllComponents(),s.remove())})}}ParticleSystem.queries={emitters:{components:[Emitter,Sprite],listen:{added:!0,removed:!0}},particles:{components:[Particle,Sprite],listen:{added:!0,removed:!0}}};class TextBox extends Component{constructor(){super(),this.text="foo"}}class PixelFont extends Component{constructor(){super(),this.src=null,this.stuff=null,this.charWidth=5,this.lineHeight=10,this.spaceWidth=1,this.ascent=8,this.halign="left",this.valign="top"}drawCharCode(e,t){if(!this.stuff)return;let s={x:0,y:0,w:0,h:0};return this.stuff.metrics[t]&&(s=this.stuff.metrics[t]),s.w>0&&e.drawImage(this.image,s.x,s.y,s.w,s.h,0,this.ascent-s.h-s.baseline,s.w,s.h),s.w+this.spaceWidth}measureCharCode(e){if(!this.stuff)return 0;let t={x:0,y:0,w:0,h:0};return this.stuff.metrics[e]&&(t=this.stuff.metrics[e]),t.w+this.spaceWidth}}class CanvasFont extends Component{constructor(){super(),this.family="sans-serif",this.size=15,this.weight="normal",this.color="black",this.halign="left",this.valign="top"}}function draw_canvas_text(e,t,s,i){let r=0,o=0;e.font=`${t.weight} ${t.size}px ${t.family}`,i.split("\n").forEach(i=>{e.fillStyle=t.color;let n=e.measureText(i);"right"===t.halign&&(r=s.width-n.width),"center"===t.halign&&(r=s.width/2-n.width/2),o+=t.size,e.fillText(i,r,o),t.debug&&(e.fillStyle="yellow",e.fillRect(r,o,n.width,1))}),t.debug&&(e.strokeStyle="red",e.strokeRect(0,0,s.width,s.height))}class TextSystem extends System{execute(e,t){this.queries.pixel_fonts.added.forEach(e=>this.load_pixel_font(e)),this.queries.pixel_text_views.added.forEach(e=>this.setup_pixel_text_view(e)),this.queries.plain_text_views.added.forEach(e=>this.setup_plain_text_view(e))}load_pixel_font(e){let t=e.getComponent(PixelFont);t.image=new Image,t.image.src=t.src,t.metrics_src&&fetch(t.metrics_src).then(e=>e.json()).then(e=>t.stuff=e)}setup_pixel_text_view(e){e.getComponent(Sprite).draw_object={draw:(t,s)=>{t.save();let i=e.getComponent(Sprite);if(i.fixed&&s.hasComponent(Camera)){let e=s.getComponent(Canvas),i=s.getComponent(Camera);t.translate(+i.x-e.width/2,+i.y-e.height/2)}let r=e.getComponent(PixelFont),o=e.getComponent(TextBox);t.translate(i.x,i.y);let n=0;o.text.split("\n").forEach(e=>{this.draw_pixel_line(t,e,r,i,0,n),n+=r.lineHeight}),r.debug&&(t.strokeStyle="red",t.strokeRect(0,0,i.width,i.height)),t.restore()}}}setup_plain_text_view(e){e.getComponent(Sprite).draw_object={draw:(t,s)=>{t.save();let i=e.getComponent(Sprite);if(i.fixed&&s.hasComponent(Camera)){let e=s.getComponent(Canvas),i=s.getComponent(Camera);t.translate(+i.x-e.width/2,+i.y-e.height/2)}let r=e.getComponent(CanvasFont),o=e.getComponent(TextBox).text;t.translate(i.x,i.y),draw_canvas_text(t,r,i,o),t.restore()}}}draw_pixel_line(e,t,s,i,r,o){let n=0;for(let e=0;e<t.length;e++)n+=s.measureCharCode(t.charCodeAt(e));"right"===s.halign&&(r=i.width-n),"center"===s.halign&&(r=i.width/2-n/2);for(let i=0;i<t.length;i++)e.save(),e.translate(r,o),r+=s.drawCharCode(e,t.charCodeAt(i)),e.restore()}}TextSystem.queries={pixel_fonts:{components:[PixelFont],listen:{added:!0}},pixel_text_views:{components:[Sprite,TextBox,PixelFont],listen:{added:!0}},plain_text_views:{components:[Sprite,TextBox,CanvasFont],listen:{added:!0}}};const ecsytwo={initialize:function(e){e.registerSystem(ECSYTwoSystem),e.registerSystem(SpriteSystem),e.registerSystem(KeyboardSystem),e.registerSystem(MouseInputSystem),e.registerSystem(LayerRenderingSystem)},start:startWorld};exports.AnimatedSprite=AnimatedSprite,exports.AudioEnabled=AudioEnabled,exports.AudioSystem=AudioSystem,exports.BackgroundFill=BackgroundFill,exports.BackgroundMusic=BackgroundMusic,exports.Camera=Camera,exports.CameraFollowsSprite=CameraFollowsSprite,exports.Canvas=Canvas,exports.CanvasFont=CanvasFont,exports.DebugOutline=DebugOutline,exports.Dialog=Dialog,exports.DialogSystem=DialogSystem,exports.DrawFilledRect=DrawFilledRect,exports.DrawImage=DrawImage,exports.DrawStrokedRect=DrawStrokedRect,exports.ECSYTwoSystem=ECSYTwoSystem,exports.Emitter=Emitter,exports.FilledSprite=FilledSprite,exports.FullscreenButton=FullscreenButton,exports.FullscreenMode=FullscreenMode,exports.FullscreenSystem=FullscreenSystem,exports.GamepadSystem=GamepadSystem,exports.ImageSprite=ImageSprite,exports.InputState=InputState,exports.KeyboardState=KeyboardState,exports.KeyboardSystem=KeyboardSystem,exports.Layer=Layer,exports.LayerParent=LayerParent,exports.LayerRenderingSystem=LayerRenderingSystem,exports.MouseInputSystem=MouseInputSystem,exports.MouseState=MouseState,exports.ParticleSystem=ParticleSystem,exports.PixelFont=PixelFont,exports.PlaySoundEffect=PlaySoundEffect,exports.SimpleGamepadState=SimpleGamepadState,exports.SoundEffect=SoundEffect,exports.Sprite=Sprite,exports.SpriteSheet=SpriteSheet,exports.SpriteSystem=SpriteSystem,exports.TextBox=TextBox,exports.TextSystem=TextSystem,exports.TileMap=TileMap,exports.TileMapSystem=TileMapSystem,exports.WaitForInput=WaitForInput,exports.default=ecsytwo,exports.load_image_from_url=load_image_from_url,exports.load_tilemap_from_url=load_tilemap_from_url,exports.make_point=make_point,exports.startWorld=startWorld,Object.defineProperty(exports,"__esModule",{value:!0})}));
